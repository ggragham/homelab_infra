*filter
# Default policies â€” drop everything unless explicitly allowed
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT DROP [0:0]

# Allow loopback interface traffic
-A INPUT -i lo -j ACCEPT
-A OUTPUT -o lo -j ACCEPT

# Allow established and related connections
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# SSH from trusted subnets
-A INPUT -p tcp --dport {{ SSH_PORT }} -s 192.168.0.0/16 -j ACCEPT
-A INPUT -p tcp --dport {{ SSH_PORT }} -s 10.0.0.0/8 -j ACCEPT
-A INPUT -p tcp --dport {{ SSH_PORT }} -s 172.16.0.0/12 -j ACCEPT

# DNS
-A INPUT  -p udp --dport 53 -j ACCEPT
-A INPUT  -p tcp --dport 53 -j ACCEPT
-A OUTPUT -p udp --dport 53 -j ACCEPT
-A OUTPUT -p tcp --dport 53 -j ACCEPT

# Samba
-A INPUT  -p tcp --dport 445 -j ACCEPT
-A OUTPUT -p tcp --dport 445 -j ACCEPT
-A INPUT  -p udp --dport 137 -j ACCEPT
-A OUTPUT -p udp --dport 137 -j ACCEPT
-A INPUT  -p udp --dport 138 -j ACCEPT
-A OUTPUT -p udp --dport 138 -j ACCEPT
-A INPUT  -p tcp --dport 139 -j ACCEPT
-A OUTPUT -p tcp --dport 139 -j ACCEPT

# Outbound traffic
{% if WIREGUARD_ENABLED %}
-A OUTPUT -o {{ WIREGUARD_CONFIG_NAME }} -j ACCEPT
-A OUTPUT -p udp --dport {{ VPN_PORT }} -o {{ NETWORK_INTERFACE }} -j ACCEPT
{% else %}
-A OUTPUT -o {{ NETWORK_INTERFACE }} -j ACCEPT
{% endif %}

COMMIT
